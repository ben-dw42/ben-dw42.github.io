<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Parlamentsrechner – Majoritäts-Proporz</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    /* ==== UNIVERSUM ==== */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Orbitron', sans-serif;
      background: #000;
      color: #0ff;
      line-height: 1.6;
      overflow-x: hidden;
      position: relative;
      min-height: 100vh;
    }

    /* Kosmischer Hintergrund */
    .universe {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: 
        radial-gradient(circle at 20% 80%, #120030 0%, #000 40%),
        radial-gradient(circle at 80% 20%, #001122 0%, #000 50%),
        radial-gradient(circle at 50% 50%, #000428 0%, #000 100%);
      z-index: -3;
    }

    .stars { position: absolute; width: 100%; height: 100%; z-index: -2; }
    .star {
      position: absolute;
      background: #fff;
      border-radius: 50%;
      box-shadow: 0 0 8px #0ff;
      animation: twinkle 3s infinite alternate;
    }
    @keyframes twinkle { 0% { opacity: 0.4; transform: scale(0.8); } 100% { opacity: 1; transform: scale(1.2); } }

    .nebula {
      position: absolute;
      width: 800px; height: 800px;
      background: radial-gradient(circle, rgba(100,0,255,0.15) 0%, transparent 70%);
      filter: blur(80px);
      animation: drift 40s infinite linear;
      z-index: -1;
    }
    .nebula:nth-child(1) { top: -200px; left: -200px; animation-duration: 50s; background: radial-gradient(circle, rgba(0,255,255,0.2) 0%, transparent 70%); }
    .nebula:nth-child(2) { bottom: -300px; right: -100px; animation-duration: 70s; background: radial-gradient(circle, rgba(255,0,150,0.18) 0%, transparent 70%); }
    .nebula:nth-child(3) { top: 20%; left: 50%; animation-duration: 60s; background: radial-gradient(circle, rgba(0,255,100,0.15) 0%, transparent 70%); }
    @keyframes drift { 0% { transform: translate(0,0) rotate(0deg); } 100% { transform: translate(100px,-100px) rotate(360deg); } }

    /* ==== GLAS-PANELS ==== */
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; position: relative; z-index: 10; }
    h1 {
      text-align: center; margin: 30px 0; font-size: 3.5rem; font-weight: 900;
      background: linear-gradient(45deg, #0ff, #f0f, #ff0);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
      text-shadow: 0 0 30px rgba(0,255,255,0.5);
      animation: title-float 6s infinite ease-in-out;
    }
    @keyframes title-float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

    .card, .settings {
      background: rgba(15, 15, 40, 0.7);
      border: 1px solid rgba(0, 255, 255, 0.4);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 25px;
      backdrop-filter: blur(12px);
      box-shadow: 
        0 0 30px rgba(0, 255, 255, 0.2),
        inset 0 0 20px rgba(0, 255, 255, 0.1);
      position: relative;
      overflow: hidden;
    }
    .card::before, .settings::before {
      content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(0,255,255,0.1), transparent);
      animation: scanline 4s infinite;
    }
    @keyframes scanline { 0% { left: -100%; } 100% { left: 100%; } }

    /* ==== EINSTELLUNGEN ==== */
    .settings {
      display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;
      padding: 18px;
    }
    .setting {
      display: flex; align-items: center; gap: 10px; color: #aaf;
    }
    label { font-weight: 700; text-shadow: 0 0 10px #0ff; }
    input[type="number"], input[type="text"] {
      width: 100px; padding: 10px; border: 1px solid #0ff; border-radius: 10px;
      background: rgba(0, 20, 40, 0.6); color: #0ff; font-family: 'Orbitron';
      box-shadow: 0 0 15px rgba(0,255,255,0.3); transition: all 0.3s;
    }
    input:focus { outline: none; box-shadow: 0 0 25px #0ff, inset 0 0 10px #0ff; }

    /* ==== PARTEIEN ==== */
    .party-row {
      display: grid; grid-template-columns: 1fr 1fr auto auto auto;
      gap: 12px; align-items: center; margin-bottom: 12px;
      padding: 14px; border: 1px solid rgba(0,255,255,0.3); border-radius: 12px;
      background: rgba(10, 30, 60, 0.5); cursor: move; user-select: none;
      transition: all 0.4s ease; position: relative;
    }
    .party-row.dragging {
      opacity: 0.6; background: rgba(0, 150, 255, 0.3); transform: scale(1.02);
      box-shadow: 0 0 30px #0ff; z-index: 1000;
    }
    .party-row input {
      padding: 10px; border: 1px solid #0ff; border-radius: 8px;
      background: rgba(0, 10, 30, 0.7); color: #0ff; font-family: 'Orbitron';
      box-shadow: 0 0 10px rgba(0,255,255,0.2);
    }
    .party-row input[type="color"] {
      width: 48px; height: 48px; padding: 2px; cursor: pointer;
      border: 2px solid #0ff; border-radius: 12px; box-shadow: 0 0 20px #0ff;
    }
    button.remove {
      background: #f03; color: white; border: none; width: 36px; height: 36px;
      border-radius: 50%; font-weight: bold; cursor: pointer;
      box-shadow: 0 0 20px #f03; transition: all 0.3s;
    }
    button.remove:hover { background: #f55; transform: scale(1.1); box-shadow: 0 0 30px #f03; }
    .drag-handle { color: #0af; font-size: 20px; cursor: move; }

    /* ==== BUTTONS ==== */
    .actions { display: flex; gap: 15px; justify-content: center; margin: 25px 0; }
    .btn {
      padding: 14px 28px; font-size: 16px; font-weight: 700; border: none; border-radius: 12px;
      cursor: pointer; font-family: 'Orbitron'; text-transform: uppercase; letter-spacing: 1px;
      transition: all 0.4s; position: relative; overflow: hidden;
    }
    .btn-primary {
      background: linear-gradient(45deg, #0af, #0f8); color: #000;
      box-shadow: 0 0 30px #0ff; text-shadow: 0 0 10px #0ff;
    }
    .btn-secondary {
      background: rgba(100, 100, 255, 0.3); color: #0ff; border: 1px solid #0ff;
      box-shadow: 0 0 20px rgba(0,255,255,0.3);
    }
    .btn:hover {
      transform: translateY(-4px) scale(1.05); box-shadow: 0 0 50px #0ff;
    }
    .btn::after {
      content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0;
      background: rgba(255,255,255,0.3); border-radius: 50%; transition: all 0.6s;
      transform: translate(-50%, -50%);
    }
    .btn:active::after { width: 300px; height: 300px; }

    /* ==== TABELLE ==== */
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th, td { padding: 14px; text-align: left; border-bottom: 1px solid rgba(0,255,255,0.3); }
    th { background: rgba(0, 50, 100, 0.6); font-weight: 700; color: #0ff; text-shadow: 0 0 10px #0ff; }
    tr:hover { background: rgba(0, 100, 200, 0.2); }
    .seats { text-align: center; font-weight: bold; color: #ff0; text-shadow: 0 0 15px #ff0; }

    /* ==== PARLAMENTSGRAFIK ==== */
    .parliament-container { text-align: center; margin: 50px 0; }
    #parliament-svg {
      background: #000; border-radius: 20px; box-shadow: 0 0 40px rgba(0,255,255,0.4);
      padding: 20px; max-width: 100%; height: auto;
    }
    .legend {
      display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;
      margin-top: 25px; font-size: 14px;
    }
    .legend-item {
      display: flex; align-items: center; gap: 8px; background: rgba(0,50,100,0.5);
      padding: 8px 16px; border-radius: 20px; border: 1px solid #0ff;
      box-shadow: 0 0 15px rgba(0,255,255,0.3); color: #0ff;
    }
    .legend-color { width: 18px; height: 18px; border-radius: 50%; box-shadow: 0 0 15px currentColor; }

    .hidden { display: none; }
    .info { text-align: center; color: #88f; font-size: 14px; margin-top: 10px; text-shadow: 0 0 8px #0ff; }

    @media (max-width: 768px) {
      h1 { font-size: 2.5rem; }
      .party-row { grid-template-columns: 1fr 1fr auto; }
      .party-row > *:nth-child(3), .party-row > *:nth-child(4), .party-row > *:nth-child(5) { grid-column: span 3; }
    }
  </style>
</head>
<body>

  <!-- Universum -->
  <div class="universe">
    <div class="stars" id="stars"></div>
    <div class="nebula"></div>
    <div class="nebula"></div>
    <div class="nebula"></div>
  </div>

  <div class="container">
    <h1>Parlamentsrechner</h1>

    <div class="settings">
      <div class="setting">
        <label for="total-seats">Sitze:</label>
        <input type="number" id="total-seats" value="630" min="1" max="50000" step="1" />
      </div>
      <div class="setting">
        <label for="huerde">Hürde (%):</label>
        <input type="number" id="huerde" value="5.0" min="0" max="100" step="0.1" />
      </div>
      <div class="setting">
        <label for="diagram-title">Titel:</label>
        <input type="text" id="diagram-title" placeholder="z.B. Bundestag 3025" />
      </div>
    </div>

    <div class="card">
      <h2 style="color:#0ff; text-shadow:0 0 15px #0ff;">Parteien</h2>
      <p class="info">Verändere die Position der Parteien um die Anordnung im Parlament zu ändern</p>
      <div id="party-container" class="party-list"></div>

      <div class="actions">
        <button class="btn btn-secondary" id="add-party">Partei hinzufügen</button>
        <button class="btn btn-primary" id="calculate">Berechnen</button>
      </div>
    </div>

    <div id="result-section" class="hidden">
      <div class="card">
        <h2 style="color:#0ff; text-shadow:0 0 15px #0ff;">Sitzverteilung</h2>
        <table id="result-table">
          <thead>
            <tr><th>Partei</th><th>Stimmen %</th><th>Sitze</th><th>Anteil</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <h2 style="color:#0ff; text-shadow:0 0 15px #0ff;">Parlamentsgrafik</h2>
        <div class="parliament-container">
          <div id="parliament-svg"></div>
        </div>
        <div class="legend" id="legend"></div>
      </div>
    </div>
  </div>

  <script>
    // === Sterne generieren ===
    const starsContainer = document.getElementById('stars');
    for (let i = 0; i < 300; i++) {
      const star = document.createElement('div');
      star.classList.add('star');
      const size = Math.random() * 3 + 1;
      const x = Math.random() * 100;
      const y = Math.random() * 100;
      const duration = Math.random() * 4 + 2;
      const delay = Math.random() * 5;
      star.style.width = `${size}px`;
      star.style.height = `${size}px`;
      star.style.left = `${x}vw`;
      star.style.top = `${y}vh`;
      star.style.animationDuration = `${duration}s`;
      star.style.animationDelay = `${delay}s`;
      starsContainer.appendChild(star);
    }

    // === Dein Original-Code (unverändert) ===
    const MAX_PARTIES = 10;
    let TOTAL_SEATS = 630;
    const colors = ['#00ffff','#ff00ff','#00ff00','#ffff00','#ff4500','#8a2be2','#00bfff','#32cd32','#ffd700','#ff1493'];

    const partyContainer = document.getElementById('party-container');
    const addPartyBtn = document.getElementById('add-party');
    const calculateBtn = document.getElementById('calculate');
    const resultSection = document.getElementById('result-section');
    const resultTableBody = document.querySelector('#result-table tbody');
    const parliamentSvg = document.getElementById('parliament-svg');
    const legendContainer = document.getElementById('legend');

    let partyCount = 0;
    let draggedRow = null;

    addPartyBtn.addEventListener('click', () => {
      if (partyCount >= MAX_PARTIES) { alert('Maximal 10 Parteien!'); return; }
      partyCount++;
      const index = partyCount - 1;

      const row = document.createElement('div');
      row.className = 'party-row';
      row.draggable = true;
      row.innerHTML = `
        <input type="text" placeholder="Parteiname" class="party-name" />
        <input type="number" placeholder="Prozent" class="party-percent" min="0" max="100" step="0.1" />
        <input type="color" value="${colors[index % colors.length]}" class="party-color" />
        <button type="button" class="remove">X</button>
        <div class="drag-handle">Drag</div>
      `;

      row.addEventListener('dragstart', (e) => {
        draggedRow = row;
        row.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
      });
      row.addEventListener('dragend', () => { row.classList.remove('dragging'); draggedRow = null; });
      row.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; });
      row.addEventListener('drop', (e) => {
        e.preventDefault();
        if (draggedRow && draggedRow !== row) {
          const allRows = Array.from(partyContainer.children);
          const fromIndex = allRows.indexOf(draggedRow);
          const toIndex = allRows.indexOf(row);
          if (fromIndex < toIndex) {
            partyContainer.insertBefore(draggedRow, row.nextSibling);
          } else {
            partyContainer.insertBefore(draggedRow, row);
          }
        }
      });

      row.querySelector('.remove').addEventListener('click', () => {
        partyContainer.removeChild(row);
        partyCount--;
      });

      partyContainer.appendChild(row);
    });

    document.getElementById('total-seats').addEventListener('input', (e) => {
      TOTAL_SEATS = Math.max(1, parseInt(e.target.value) || 630);
      e.target.value = TOTAL_SEATS;
    });

    calculateBtn.addEventListener('click', () => {
      TOTAL_SEATS = parseInt(document.getElementById('total-seats').value) || 630;
      const huerde = parseFloat(document.getElementById('huerde').value) || 5.0;
      const title = document.getElementById('diagram-title').value.trim();
      const rows = partyContainer.querySelectorAll('.party-row');

      if (rows.length === 0) { alert('Bitte füge mindestens eine Partei hinzu.'); return; }

      const inputParties = [];
      let valid = true;

      rows.forEach(row => {
        const name = row.querySelector('.party-name').value.trim();
        const percent = parseFloat(row.querySelector('.party-percent').value);
        const color = row.querySelector('.party-color').value;

        if (!name || isNaN(percent) || percent < 0) { valid = false; return; }
        inputParties.push({ name, percent, color });
      });

      if (!valid) { alert('Bitte alle Felder korrekt ausfüllen.'); return; }

      const seats = majoritaetsProporz(inputParties, huerde);
      const orderedParties = inputParties.map(p => ({
        name: p.name,
        color: p.color,
        seats: seats[p.name] || 0,
        percent: p.percent
      })).filter(p => p.seats > 0);

      displayResults(orderedParties, title);
    });

    function majoritaetsProporz(partiesInput, huerde = 5.0) {
      const above = partiesInput.filter(p => p.percent >= huerde);
      if (above.length === 0) return {};

      const half = Math.ceil(TOTAL_SEATS / 2);
      const remaining = TOTAL_SEATS - half - (TOTAL_SEATS % 2 === 0 ? 1 : 0);

      const strongest = above.reduce((a, b) => a.percent > b.percent ? a : b);
      const seats = { [strongest.name]: half + (TOTAL_SEATS % 2 === 0 ? 1 : 0) };

      const others = above.filter(p => p.name !== strongest.name);
      const totalOther = others.reduce((s, p) => s + p.percent, 0);

      others.forEach(p => {
        const ratio = totalOther > 0 ? p.percent / totalOther : 0;
        seats[p.name] = Math.floor(ratio * remaining);
      });

      const sortedOthers = others.sort((a, b) => a.percent - b.percent);
      let i = 0;
      while (Object.values(seats).reduce((a, b) => a + b, 0) < TOTAL_SEATS) {
        const p = sortedOthers[i % sortedOthers.length];
        seats[p.name]++;
        i++;
      }

      return seats;
    }

    const totals = [3,15,33,61,95,138,189,247,313,388,469,559,657,762,876,997,1126,1263,1408,1560,1722,1889,2066,2250,2442,2641,2850,3064,3289,3519,3759,4005,4261,4522,4794,5071,5358,5652,5953,6263,6581,6906,7239,7581,7929,8287,8650,9024,9404,9793,10187,10594,11003,11425,11850,12288,12729,13183,13638,14109,14580,15066,15553,16055,16557,17075,17592,18126,18660,19208,19758,20323,20888,21468,22050,22645,23243,23853,24467,25094,25723,26364,27011,27667,28329,29001,29679,30367,31061];

    function generateArchSVG(partyData, title = "") {
      if (partyData.length === 0) return "";
      const totalSeats = partyData.reduce((s, p) => s + p.seats, 0);
      if (totalSeats <= 0) return "";
      const rowCount = totals.findIndex(t => t >= totalSeats) + 1;
      if (rowCount <= 0) return "";
      const circleRadius = 0.4 / rowCount;
      const positions = getSpotCentres(totalSeats, rowCount, false);

      let svg = `<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 360 ${title ? 205 : 185}">
<g>`;

      svg += `<text x="180" y="175" style="font-size:36px;font-weight:bold;text-anchor:middle;font-family:Orbitron, sans-serif;fill:#0ff;text-shadow:0 0 10px #0ff;">${totalSeats}</text>`;
      if (title) {
        svg += `<text x="180" y="200" style="font-size:20px;font-weight:bold;text-anchor:middle;font-family:Orbitron, sans-serif;fill:#ff0;text-shadow:0 0 8px #ff0;">${title}</text>`;
      }

      let drawn = 0;
      partyData.forEach((p, idx) => {
        const name = p.name.replace(/[^a-zA-Z0-9_-]+/g, "-");
        svg += `<g style="fill:${p.color}; stroke:${p.color}; stroke-width:1;" id="${name}_${idx}"><title>${p.name}</title>`;
        for (let i = drawn; i < drawn + p.seats; i++) {
          const pos = positions[i];
          const cx = 5.0 + 100.0 * pos.x;
          const cy = 5.0 + 100.0 * (1.75 - pos.y);
          const r = circleRadius * 100.0;
          svg += `<circle cx="${cx}" cy="${cy}" r="${r}" style="filter: drop-shadow(0 0 8px ${p.color}"/>`;
        }
        svg += `</g>`;
        drawn += p.seats;
      });

      svg += `</g></svg>`;
      return svg;
    }

    function getSpotCentres(totalSeats, rowCount, denseRows) {
      let discardRows = 0, diagramFullness = 1;
      if (denseRows) {
        [discardRows, diagramFullness] = optimiseRows(totalSeats, rowCount);
      } else {
        diagramFullness = totalSeats / totals[rowCount - 1];
      }
      let positions = [];
      for (let i = discardRows + 1; i < rowCount; i++) {
        positions = appendRowSeats(positions, i, rowCount, diagramFullness);
      }
      positions = appendFinalSeats(positions, totalSeats - positions.length, rowCount);
      positions.sort((a, b) => b.angle - a.angle || b.x - a.x || b.y - a.y);
      return positions;
    }

    function optimiseRows(totalSeats, rowCount) {
      let handled = 0;
      for (let i = rowCount; i > 0; i--) {
        const magic = 3 * rowCount + 4 * i - 2;
        const maxInRow = Math.PI / (2 * Math.asin(2 / magic));
        handled += Math.trunc(maxInRow);
        if (handled >= totalSeats) {
          return [i - 1, totalSeats / handled];
        }
      }
      return [0, 0];
    }

    function appendRowSeats(positions, index, rowCount, fullness) {
      const magic = 3.0 * rowCount + 4.0 * index - 2.0;
      const maxSeats = Math.PI / (2 * Math.asin(2.0 / magic));
      const seats = Math.trunc(fullness * maxSeats);
      const radius = magic / (4.0 * rowCount);
      return appendSeatPositions(positions, seats, radius, 0.4 / rowCount);
    }

    function appendFinalSeats(positions, leftover, rowCount) {
      const radius = (7 * rowCount - 2) / (4 * rowCount);
      return appendSeatPositions(positions, leftover, radius, 0.4 / rowCount);
    }

    function appendSeatPositions(positions, seatsInRow, rowRadius, circleRadius) {
      const ratio = Math.sin(circleRadius / rowRadius);
      for (let i = 0; i < seatsInRow; i++) {
        let angle = seatsInRow === 1 ? Math.PI / 2 : i * (Math.PI - 2 * ratio) / (seatsInRow - 1) + ratio;
        positions.push({
          angle,
          x: rowRadius * Math.cos(angle) + 1.75,
          y: rowRadius * Math.sin(angle)
        });
      }
      return positions;
    }

    function displayResults(parties, title) {
      resultTableBody.innerHTML = '';
      legendContainer.innerHTML = '';
      parliamentSvg.innerHTML = '';

      parties.forEach(p => {
        const row = document.createElement('tr');
        const share = ((p.seats / TOTAL_SEATS) * 100).toFixed(2);
        row.innerHTML = `
          <td><span style="display:inline-block;width:14px;height:14px;border-radius:50%;background:${p.color};margin-right:10px;box-shadow:0 0 15px ${p.color};"></span>${p.name}</td>
          <td>${p.percent.toFixed(2)}%</td>
          <td class="seats">${p.seats}</td>
          <td>${share}%</td>
        `;
        resultTableBody.appendChild(row);
      });

      parties.forEach(p => {
        const item = document.createElement('div');
        item.className = 'legend-item';
        item.innerHTML = `<div class="legend-color" style="background:${p.color};box-shadow:0 0 15px ${p.color};"></div><span>${p.name}: ${p.seats} Sitze</span>`;
        legendContainer.appendChild(item);
      });

      const svg = generateArchSVG(parties, title);
      parliamentSvg.innerHTML = svg;

      resultSection.classList.remove('hidden');
    }

    // Initial
    addPartyBtn.click();
  </script>
</body>
</html>